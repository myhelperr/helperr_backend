{"version":3,"file":"authMiddleware.js","sources":["middlewares/authMiddleware.ts"],"sourceRoot":"/","sourcesContent":["import { Request, Response, NextFunction } from 'express';\r\nimport createError from 'http-errors';\r\n\r\nimport { supabase } from '../configs/supaBase';\r\nimport prisma from '../configs/prisma';\r\nimport catchAsync from '../utils/catchAsync';\r\n\r\nexport const authMiddleware = catchAsync(\r\n  async (req: Request, __: Response, next: NextFunction) => {\r\n    // Get authorization header\r\n    const authHeader = req.headers['authorization'];\r\n\r\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n      return next(createError(401, 'No token provided'));\r\n    }\r\n\r\n    // Extract token\r\n    const token = authHeader.split(' ')[1];\r\n\r\n    if (!token) return next(createError(401, 'Invalid token format'));\r\n\r\n    // Verify token with Supabase\r\n    const { data, error } = await supabase.auth.getUser(token);\r\n\r\n      if (error || !data.user) {\r\n        return next(createError(401, 'Invalid or expired token'));\r\n      }\r\n\r\n      // Get user from database\r\n      const user = await prisma.user.findUnique({\r\n        where: { id: data.user.id },\r\n      });\r\n\r\n      if (!user) {\r\n        return next(createError(404, 'User not found'));\r\n      }\r\n\r\n      if (!user.isVerified) {\r\n        return next(createError(403, 'Please verify your email first'));\r\n      }\r\n\r\n      // Attach user to request object\r\n      req.user = user;\r\n\r\n      next();\r\n  }\r\n);"],"names":[],"mappings":";;;;;;;;AACA,8DAAsC;AAEtC,kDAA+C;AAC/C,+DAAuC;AACvC,qEAA6C;AAEhC,QAAA,cAAc,GAAG,IAAA,oBAAU,EACtC,KAAK,EAAE,GAAY,EAAE,EAAY,EAAE,IAAkB,EAAE,EAAE;IAEvD,MAAM,UAAU,GAAG,GAAG,CAAC,OAAO,CAAC,eAAe,CAAC,CAAC;IAEhD,IAAI,CAAC,UAAU,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,SAAS,CAAC,EAAE,CAAC;QACrD,OAAO,IAAI,CAAC,IAAA,qBAAW,EAAC,GAAG,EAAE,mBAAmB,CAAC,CAAC,CAAC;IACrD,CAAC;IAGD,MAAM,KAAK,GAAG,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;IAEvC,IAAI,CAAC,KAAK;QAAE,OAAO,IAAI,CAAC,IAAA,qBAAW,EAAC,GAAG,EAAE,sBAAsB,CAAC,CAAC,CAAC;IAGlE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,mBAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;IAEzD,IAAI,KAAK,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC;QACxB,OAAO,IAAI,CAAC,IAAA,qBAAW,EAAC,GAAG,EAAE,0BAA0B,CAAC,CAAC,CAAC;IAC5D,CAAC;IAGD,MAAM,IAAI,GAAG,MAAM,gBAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QACxC,KAAK,EAAE,EAAE,EAAE,EAAE,IAAI,CAAC,IAAI,CAAC,EAAE,EAAE;KAC5B,CAAC,CAAC;IAEH,IAAI,CAAC,IAAI,EAAE,CAAC;QACV,OAAO,IAAI,CAAC,IAAA,qBAAW,EAAC,GAAG,EAAE,gBAAgB,CAAC,CAAC,CAAC;IAClD,CAAC;IAED,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE,CAAC;QACrB,OAAO,IAAI,CAAC,IAAA,qBAAW,EAAC,GAAG,EAAE,gCAAgC,CAAC,CAAC,CAAC;IAClE,CAAC;IAGD,GAAG,CAAC,IAAI,GAAG,IAAI,CAAC;IAEhB,IAAI,EAAE,CAAC;AACX,CAAC,CACF,CAAC","debug_id":"53f4c204-717c-5e38-8942-bc3d3318251a"}